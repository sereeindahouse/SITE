<%- include('include/header') %>

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Groups</h4>
    <% if (me) { %>
      <form action="/groups" method="POST" class="form-inline">
        <input type="text" class="form-control mr-2" name="name" placeholder="New group name" required>
        <input type="text" class="form-control mr-2" name="description" placeholder="Description">
        <button class="btn btn-sm btn-success">Create</button>
      </form>
    <% } %>
  </div>

  <% if (groups && groups.length) { %>
    <ul class="list-group">
      <% groups.forEach(function(g){ %>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <a href="/groups/<%= g._id %>"><strong><%= g.name %></strong></a>
            <div class="small text-muted"><%= g.description || '' %></div>
          </div>
          <div class="d-flex align-items-center">
            <small class="text-muted mr-3">members: <%= (g.members || []).length %></small>
            <button type="button" class="btn btn-link btn-sm mr-2" data-toggle="modal" data-target="#members-<%= g._id %>">See</button>
            <% if (me) { %>
              <% const isMember = (g.members || []).some(m => m.toLowerCase() === me.toLowerCase()); %>
              <% const isPending = (g.joinRequests || []).some(u => u.toLowerCase() === me.toLowerCase()); %>
              <% if (isMember) { %>
                <form action="/groups/<%= g._id %>/leave" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-outline-secondary">Leave</button>
                </form>
              <% } else if (isPending) { %>
                <button class="btn btn-sm btn-outline-secondary" disabled>Requested</button>
              <% } else { %>
                <form action="/groups/<%= g._id %>/join" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-success">Join</button>
                </form>
              <% } %>
            <% } %>
          </div>
        </li>
        <!-- Members Modal per group row -->
        <div class="modal fade" id="members-<%= g._id %>" tabindex="-1" role="dialog" aria-labelledby="membersLabel-<%= g._id %>" aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="membersLabel-<%= g._id %>">Members of <%= g.name %></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body p-0">
                <% const members = g.members || []; %>
                <% if (members.length) { %>
                  <ul class="list-group list-group-flush">
                    <% members.forEach(function(m){ %>
                      <li class="list-group-item"><a href="/profile/<%= m %>"><%= m %></a></li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <div class="p-3 text-muted">No members yet.</div>
                <% } %>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </ul>
  <% } else { %>
    <div class="alert alert-info">No groups yet.</div>
  <% } %>
</div>

<%- include('include/footer') %>
