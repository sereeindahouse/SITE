<%- include('include/header') %>

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0"><%= group.name %></h4>
      <div class="text-muted"><%= group.description || '' %></div>
    </div>
    <div>
      <% if (!isMember) { %>
        <% if (isPending) { %>
          <button class="btn btn-sm btn-outline-secondary" disabled>Requested</button>
        <% } else { %>
          <form action="/groups/<%= group._id %>/join" method="POST" class="d-inline">
            <button class="btn btn-sm btn-success">Join</button>
          </form>
        <% } %>
      <% } else { %>
        <form action="/groups/<%= group._id %>/leave" method="POST" class="d-inline">
          <button class="btn btn-sm btn-secondary">Leave</button>
        </form>
      <% } %>
    </div>
  </div>

  <% if (isAdmin && (group.joinRequests || []).length) { %>
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title">Join Requests</h6>
        <ul class="list-group">
          <% (group.joinRequests || []).forEach(function(u){ %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="/profile/<%= u %>"><%= u %></a>
              <div>
                <form action="/groups/<%= group._id %>/approve/<%= u %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-success">Confirm</button>
                </form>
                <form action="/groups/<%= group._id %>/reject/<%= u %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-secondary">Delete</button>
                </form>
              </div>
            </li>
          <% }) %>
        </ul>
      </div>
    </div>
  <% } %>

  <% if (isMember) { %>
    <div class="d-flex justify-content-end mb-2">
      <a class="btn btn-sm btn-primary" data-toggle="collapse" href="#group-create-form" role="button" aria-expanded="false" aria-controls="group-create-form">
        Create Group Post
      </a>
    </div>
    <div id="group-create-form" class="collapse">
      <div class="card mb-3">
        <div class="card-body">
          <form action="/groups/<%= group._id %>/create-post" method="POST">
            <div class="form-group">
              <label>Title</label>
              <input name="title" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Body</label>
              <textarea name="body" class="form-control" rows="4" required></textarea>
            </div>
            <button class="btn btn-success btn-sm">Create Group Post</button>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <h6>Posts</h6>
  <% if (posts && posts.length) { %>
    <ul class="list-group">
      <% posts.forEach(function(p){ %>
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong><%= p.title %></strong>
              <div class="small text-muted">by <%= p.author %> â€¢ <%= new Date(p.createdDate).toLocaleString() %></div>
              <div class="mt-2"><%= (p.body || '').slice(0, 200) %></div>
            </div>
            <div class="text-right">
              <div class="small text-muted mb-2">likes: <%= (p.likes || []).length %></div>
              <form action="/groups/<%= group._id %>/like/<%= p._id %>" method="POST" class="d-inline">
                <button class="btn btn-sm btn-outline-primary">Like</button>
              </form>
              <form action="/groups/<%= group._id %>/unlike/<%= p._id %>" method="POST" class="d-inline">
                <button class="btn btn-sm btn-outline-secondary">Unlike</button>
              </form>
              <% if (isAdmin && p.author !== group.createdBy) { %>
                <form action="/groups/<%= group._id %>/kick/<%= p.author %>" method="POST" class="d-inline mt-1">
                  <button class="btn btn-sm btn-danger">Kick <%= p.author %></button>
                </form>
              <% } %>
            </div>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } else { %>
    <div class="alert alert-info">No posts in this group yet.</div>
  <% } %>
</div>

<%- include('include/footer') %>
