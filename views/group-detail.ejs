<%- include('include/header') %>

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0"><%= group.name %></h4>
      <div class="text-muted"><%= group.description || '' %></div>
    </div>
    <div>
      <button type="button" class="btn btn-link btn-sm mr-2" data-toggle="modal" data-target="#members-modal">See members (<%= (group.members || []).length %>)</button>
      <% if (!isMember) { %>
        <% if (isPending) { %>
          <button class="btn btn-sm btn-outline-secondary" disabled>Requested</button>
        <% } else { %>
          <form action="/groups/<%= group._id %>/join" method="POST" class="d-inline">
            <button class="btn btn-sm btn-success">Join</button>
          </form>
        <% } %>
      <% } else { %>
        <form action="/groups/<%= group._id %>/leave" method="POST" class="d-inline">
          <button class="btn btn-sm btn-secondary">Leave</button>
        </form>
      <% } %>
    </div>
  </div>

  <!-- Members Modal for group-detail -->
  <div class="modal fade" id="members-modal" tabindex="-1" role="dialog" aria-labelledby="membersLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="membersLabel">Members of <%= group.name %></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body p-0">
          <% const membersList = group.members || []; %>
          <% if (membersList.length) { %>
            <ul class="list-group list-group-flush">
              <% membersList.forEach(function(m){ %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <a href="/profile/<%= m %>"><%= m %></a>
                  <% if (isAdmin && m !== group.createdBy) { %>
                    <form action="/groups/<%= group._id %>/kick/<%= m %>" method="POST" class="d-inline">
                      <button class="btn btn-sm btn-outline-danger">Kick</button>
                    </form>
                  <% } %>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <div class="p-3 text-muted">No members yet.</div>
          <% } %>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <% if (isAdmin && (group.joinRequests || []).length) { %>
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title">Join Requests</h6>
        <ul class="list-group">
          <% (group.joinRequests || []).forEach(function(u){ %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="/profile/<%= u %>"><%= u %></a>
              <div>
                <form action="/groups/<%= group._id %>/approve/<%= u %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-success">Confirm</button>
                </form>
                <form action="/groups/<%= group._id %>/reject/<%= u %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-secondary">Delete</button>
                </form>
              </div>
            </li>
          <% }) %>
        </ul>
      </div>
    </div>
  <% } %>

  <% if (isMember) { %>
    <div class="d-flex justify-content-end mb-2">
      <a class="btn btn-sm btn-primary" data-toggle="collapse" href="#group-create-form" role="button" aria-expanded="false" aria-controls="group-create-form">
        Create Group Post
      </a>
    </div>
    <div id="group-create-form" class="collapse">
      <div class="card mb-3">
        <div class="card-body">
          <form action="/groups/<%= group._id %>/create-post" method="POST">
            <div class="form-group">
              <label>Title</label>
              <input name="title" class="form-control" required>
            </div>
            <div class="form-group">
              <label>Body</label>
              <textarea name="body" class="form-control" rows="4" required></textarea>
            </div>
            <button class="btn btn-success btn-sm">Create Group Post</button>
          </form>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Tabs: Posts | Members -->
  <ul class="nav nav-tabs mt-3" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="posts-tab" data-toggle="tab" href="#posts" role="tab" aria-controls="posts" aria-selected="true">Posts</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="members-tab" data-toggle="tab" href="#members" role="tab" aria-controls="members" aria-selected="false">Members (<%= (group.members || []).length %>)</a>
    </li>
  </ul>
  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="posts" role="tabpanel" aria-labelledby="posts-tab">
      <% if (posts && posts.length) { %>
        <ul class="list-group">
          <% posts.forEach(function(p){ %>
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong><%= p.title %></strong>
                  <div class="small text-muted">by <%= p.author %> â€¢ <%= new Date(p.createdDate).toLocaleString() %></div>
                  <div class="mt-2"><%= (p.body || '').slice(0, 200) %></div>
                </div>
                <div class="text-right">
                  <div class="small text-muted mb-2">
                    likes: <%= (p.likes || []).length %>
                    <!-- View likes modal trigger -->
                    <button type="button" class="btn btn-link btn-sm p-0 ml-2" data-toggle="modal" data-target="#likes-<%= p._id %>">View likes</button>
                  </div>
                  <form action="/groups/<%= group._id %>/like/<%= p._id %>" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-outline-primary">Like</button>
                  </form>
                  <form action="/groups/<%= group._id %>/unlike/<%= p._id %>" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-outline-secondary">Unlike</button>
                  </form>
                  <% if (isAdmin && p.author !== group.createdBy) { %>
                    <form action="/groups/<%= group._id %>/kick/<%= p.author %>" method="POST" class="d-inline mt-1">
                      <button class="btn btn-sm btn-danger">Kick <%= p.author %></button>
                    </form>
                  <% } %>
                </div>
              </div>

              <!-- Likes Modal for this post -->
              <div class="modal fade" id="likes-<%= p._id %>" tabindex="-1" role="dialog" aria-labelledby="likesLabel-<%= p._id %>" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="likesLabel-<%= p._id %>">Liked by</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body p-0">
                      <% if (p.likes && p.likes.length) { %>
                        <ul class="list-group list-group-flush">
                          <% p.likes.forEach(function(u){ %>
                            <li class="list-group-item"><a href="/profile/<%= u %>"><%= u %></a></li>
                          <% }) %>
                        </ul>
                      <% } else { %>
                        <div class="p-3 text-muted">No likes yet.</div>
                      <% } %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <div class="alert alert-info">No posts in this group yet.</div>
      <% } %>
    </div>
    <div class="tab-pane fade" id="members" role="tabpanel" aria-labelledby="members-tab">
      <% const members = group.members || []; %>
      <% if (members.length) { %>
        <ul class="list-group">
          <% members.forEach(function(m){ %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <a href="/profile/<%= m %>"><%= m %></a>
              <% if (isAdmin && m !== group.createdBy) { %>
                <form action="/groups/<%= group._id %>/kick/<%= m %>" method="POST" class="d-inline">
                  <button class="btn btn-sm btn-outline-danger">Kick</button>
                </form>
              <% } %>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <div class="alert alert-info">No members yet.</div>
      <% } %>
    </div>
  </div>
</div>

<%- include('include/footer') %>
